---
title: "Midterm Take Home Portion"
author: "Jenn Lewis, Tamara Niella"
date: "4/27/2019"
output: html_document
---

```{r setup}
knitr::opts_chunk$set(echo = TRUE)
knitr::opts_chunk$set(cache = TRUE)
#install.packages("glue")
#install.packages("pracma")
library(glue)
library(rio)
library(purrr)
library(tidyverse)
library(pracma)

```

```{r Part A 1}
#Function to download data from link
download_file <- function(year) {
    link <- glue::glue("https://www.oregon.gov/ode/educator-resources/assessment/TestResults20{year}/pagr_schools_ela_raceethnicity_{year-1}{year}.xlsx")
    rio::import(link, setclass = "tibble", na = c("-", "--", "*"))
}

#Load data from multiple years and bind into single data frame
data <- map_df(15:18, download_file, .id = "year_link")

#Clean Data
data %<>%
  #clean names
  janitor::clean_names() %>%
  #filter for white and hispanic/latino students
  filter(student_group == "White" | 
         student_group == "Hispanic/Latino") %>%
  #select variables, drop percentages and collapsed levels
  select(academic_year,
         district,
         school,
         student_group,
         grade_level,
         starts_with("number_level")) %>%
  #gather number_level data to be two columns, level and n
  gather("level", "n", starts_with("number_level")) %>%
  #Convert level to a number, remove number_level_
  mutate(level = parse_number(level)) %>%
  #remove missing data
  filter(!is.na(n))

#Convert variables to factors
data <- data %>%
  mutate(academic_year = as.factor(academic_year),
         level = as.factor(level), 
         grade_level = as.factor(grade_level))

```


```{r Part A Question 2}
#Calculate the cumulative n for each school by student_group, grade, and academic_year.
data <- data %>%
  #need to arrange data before grouping 
  arrange(school,student_group, grade_level, academic_year, level) %>% 
  #group data
  group_by(school,student_group, grade_level, academic_year) %>%
  #create cn variable
  mutate(cn = cumsum(n))

```



```{r Part A Question 3}
#Reformat the data so it looks like the below, removing n and filling by cn. Remove rows that have missing data for either student group.
data %<>%
  #drop n column
  select(everything(), -n) %>%
  #spread the student_group out into two columns
  spread(student_group, cn) %>%
  #clean names
  janitor::clean_names() %>%
  #filter out missing data
  filter(!is.na(white))

#Tried to do this in the pipe above but didn't work, not sure why so did it as a seperate step
        
data <- data %>%
  filter(!is.na(hispanic_latino))



```

```{r Part B Question 1}
gap <- function(data, ref, foc) {
    x <- data[[ref]]
    y <- data[[foc]]
    auc <- pracma::trapz(y / y[length(x)],
                         x / x[length(x)])
    sqrt(2)*qnorm(auc)
}

#Estimate an achievement gap effect size for every school in the state that reported data on both student groups (i.e., using the data we created above), for each grade level in each academic year.

#group data and nest to create seperate data frames; pretty sure this part is correct
nested_data <- data %>%
  group_by(academic_year, district, school, grade_level) %>%
  nest()

#create achievement gap effect size by looping through each data frame
nested_data <- nested_data%>% 
  mutate(es = map_dbl(data, ~gap(.x, "white", "hispanic_latino")))

```

```{r Part B Question 2}

#nested and sliced data

data_b2 <- nested_data %>% 
  nest()%>% 
  slice(1:100)

#I need to get the district info so I create a function 
district <- function (a) { a$district[[1]]}

#try

district(data_b2$data)
```

