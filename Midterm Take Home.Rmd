---
title: "Midterm Take Home Portion"
author: "Jenn Lewis, Tamara Niella"
date: "4/27/2019"
output: html_document
---

```{r setup}
knitr::opts_chunk$set(echo = TRUE)
knitr::opts_chunk$set(cache = TRUE)
#install.packages("glue")
#install.packages("pracma")
library(glue)
library(rio)
library(purrr)
library(tidyverse)
library(pracma)

```

```{r Part A 1}
#Function to download data from link
download_file <- function(year) {
    link <- glue::glue("https://www.oregon.gov/ode/educator-resources/assessment/TestResults20{year}/pagr_schools_ela_raceethnicity_{year-1}{year}.xlsx")
    rio::import(link, setclass = "tibble", na = c("-", "--", "*"))
}

#Load data from multiple years and bind into single data frame
data <- map_df(15:18, download_file, .id = "year_link")

#Clean Data
data %<>%
  #clean names
  janitor::clean_names() %>%
  #filter for white and hispanic/latino students
  filter(student_group == "White" | 
         student_group == "Hispanic/Latino") %>%
  #select variables, drop percentages and collapsed levels
  select(year_link,
         academic_year,
         district,
         school,
         student_group,
         grade_level,
         starts_with("number_level")) %>%
  #gather number_level data to be two columns, level and n
  gather("level", "n", starts_with("number_level")) %>%
  #Convert level to a number, remove number_level_
  mutate(level = parse_number(level)) %>%
  #remove missing data
  filter(!is.na(n))

```


```{r Part A Question 2}
#Calculate the cumulative n for each school by student_group, grade, and academic_year.
data <- data %>%
  group_by(school,student_group, grade_level, academic_year) %>%
  mutate(cn = cumsum(n))

```



```{r Part A Question 3}
data %<>%
  select(data, -n) %<%
  spread(student_group, cn) %>%
  filter(!is.na(white) |
           ~!is.na(hispanic/latino))


```

```{r Part B Question 1}
gap <- function(data, ref, foc) {
    x <- data[[ref]]
    y <- data[[foc]]
    auc <- pracma::trapz(y / y[length(x)],
                         x / x[length(x)])
    sqrt(2)*qnorm(auc)
}


